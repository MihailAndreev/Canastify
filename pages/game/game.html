<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canastify - Игра</title>
  <link rel="stylesheet" href="./game.css">
</head>
<body>
  <div class="board">
    <!-- Link Vector Cards CSS -->
    <link rel="stylesheet" href="../../src/shared/ui/cardDisplay.css">
    
    <!-- Top Player Bar -->
    <div class="top-bar">
      <!-- Opponent 1 -->
      <div class="player-tile team-opponent">
        <div class="player-info">
          <div class="avatar">O1</div>
          <div class="player-label">Opponent 1</div>
        </div>
        <div class="counters">
          <div class="counter-card blue-counter">
            <span class="counter-value">11</span>
          </div>
          <div class="counter-card red3-counter">
            <span class="red3-symbol">3</span>
            <div class="red3-badge">0</div>
          </div>
        </div>
      </div>

      <!-- Partner -->
      <div class="player-tile team-our">
        <div class="player-info">
          <div class="avatar">PT</div>
          <div class="player-label">Partner</div>
        </div>
        <div class="counters">
          <div class="counter-card blue-counter">
            <span class="counter-value">9</span>
          </div>
          <div class="counter-card red3-counter">
            <span class="red3-symbol">3</span>
            <div class="red3-badge">2</div>
          </div>
        </div>
      </div>

      <!-- Opponent 2 -->
      <div class="player-tile team-opponent">
        <div class="player-info">
          <div class="avatar">O2</div>
          <div class="player-label">Opponent 2</div>
        </div>
        <div class="counters">
          <div class="counter-card blue-counter">
            <span class="counter-value">10</span>
          </div>
          <div class="counter-card red3-counter">
            <span class="red3-symbol">3</span>
            <div class="red3-badge">1</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Middle Area: 3 Columns -->
    <div class="middle-area">
      <!-- Left Column: Our Team Melds -->
      <div class="meld-panel team-our">
        <h2 class="panel-title">OUR TEAM MELDS</h2>
        <div class="meld-grid">
          <div class="meld-slot" id="meld-slot-1">
            <div class="meld-cards"></div>
          </div>
          <div class="meld-slot" id="meld-slot-2">
            <div class="meld-cards"></div>
          </div>
          <div class="meld-slot"><span class="slot-label">M3</span></div>
          <div class="meld-slot"><span class="slot-label">M4</span></div>
          <div class="meld-slot"><span class="slot-label">M5</span></div>
          <div class="meld-slot"><span class="slot-label">M6</span></div>
          <div class="meld-slot"><span class="slot-label">M7</span></div>
          <div class="meld-slot"><span class="slot-label">M8</span></div>
          <div class="meld-slot"><span class="slot-label">M9</span></div>
          <div class="meld-slot"><span class="slot-label">M10</span></div>
          <div class="meld-slot"><span class="slot-label">M11</span></div>
          <div class="meld-slot"><span class="slot-label">M12</span></div>
          <div class="meld-slot"><span class="slot-label">M13</span></div>
          <div class="meld-slot"><span class="slot-label">M14</span></div>
          <div class="meld-slot"><span class="slot-label">M15</span></div>
          <div class="meld-slot"><span class="slot-label">M16</span></div>
          <div class="meld-slot"><span class="slot-label">M17</span></div>
          <div class="meld-slot"><span class="slot-label">M18</span></div>
          <div class="meld-slot"><span class="slot-label">M19</span></div>
          <div class="meld-slot"><span class="slot-label">M20</span></div>
        </div>
      </div>

      <!-- Center Column: Deck & Discard -->
      <div class="center-column">
        <div class="deck-discard-stack">
          <div class="deck">
            <div class="deck-card">
              <div class="deck-pattern"></div>
            </div>
            <div class="deck-badge">49</div>
            <div class="deck-label">DECK</div>
          </div>
          <div class="discard">
            <div class="discard-card">
              <img src="../../assets/cards/vector_cards/FACES (PRINTABLE)/STANDARD (PRINTABLE)/Single Cards (One Per FIle)/DIAMOND-12-QUEEN.svg" alt="Queen of Diamonds" class="card-svg">
            </div>
            <div class="discard-badge">12</div>
            <div class="discard-label">DISCARD</div>
          </div>
        </div>
        <div class="turn-pill">
          <span class="play-icon">▶</span> Player_name's turn
        </div>
      </div>

      <!-- Right Column: Opponent Melds -->
      <div class="meld-panel team-opponent">
        <h2 class="panel-title">OPPONENT MELDS</h2>
        <div class="meld-grid">
          <div class="meld-slot"><span class="slot-label">M1</span></div>
          <div class="meld-slot" id="opp-meld-slot-2">
            <div class="meld-cards"></div>
          </div>
          <div class="meld-slot"><span class="slot-label">M3</span></div>
          <div class="meld-slot"><span class="slot-label">M4</span></div>
          <div class="meld-slot"><span class="slot-label">M5</span></div>
          <div class="meld-slot"><span class="slot-label">M6</span></div>
          <div class="meld-slot"><span class="slot-label">M7</span></div>
          <div class="meld-slot"><span class="slot-label">M8</span></div>
          <div class="meld-slot"><span class="slot-label">M9</span></div>
          <div class="meld-slot"><span class="slot-label">M10</span></div>
          <div class="meld-slot"><span class="slot-label">M11</span></div>
          <div class="meld-slot"><span class="slot-label">M12</span></div>
          <div class="meld-slot"><span class="slot-label">M13</span></div>
          <div class="meld-slot"><span class="slot-label">M14</span></div>
          <div class="meld-slot"><span class="slot-label">M15</span></div>
          <div class="meld-slot"><span class="slot-label">M16</span></div>
          <div class="meld-slot"><span class="slot-label">M17</span></div>
          <div class="meld-slot"><span class="slot-label">M18</span></div>
          <div class="meld-slot"><span class="slot-label">M19</span></div>
          <div class="meld-slot"><span class="slot-label">M20</span></div>
        </div>
      </div>
    </div>

    <!-- Bottom: Player's Hand -->
    <div class="hand team-our" id="player-hand">
      <!-- Vector Cards will be loaded here -->
      
      <!-- Hand Counters Section -->
      <div class="hand-counters-container">
        <div class="hand-counter-item">
          <div class="hand-badge blue-badge" id="hand-card-count">0</div>
          <div class="counter-label">CARDS</div>
        </div>
        <div class="hand-counter-item">
          <div class="hand-badge red-badge" id="hand-red3-count">0</div>
          <div class="counter-label">RED 3s</div>
        </div>
      </div>

      <!-- Player Action Buttons -->
      <div class="player-actions">
        <button id="btnSortHand" type="button" style="background-color: #007bff; color: white;">Sort</button>
        <button id="btnDrawDeck" type="button">Draw from deck</button>
        <button id="btnTakeDiscard" type="button">Take discard pile</button>
        <button id="btnMeld" type="button" disabled>Meld</button>
        <button id="btnDiscard" type="button" disabled>Discard</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createCard, JOKER, SUITS } from '../../src/domain/cardMapping.js';
    import { createHandDisplay } from '../../src/shared/ui/cardDisplay.js';

    // Populate Meld Slot 1 with 5 cards (Aces)
    const meldSlot1Cards = [
      createCard(SUITS.HEART, 1),   // Ace of Hearts
      createCard(SUITS.DIAMOND, 1), // Ace of Diamonds
      createCard(SUITS.CLUB, 1),    // Ace of Clubs
      createCard(SUITS.SPADE, 1),   // Ace of Spades
      createCard(SUITS.HEART, 1),   // Ace of Hearts (duplicate)
    ];

    // Populate Meld Slot 2 with 7 cards (Kings)
    const meldSlot2Cards = [
      createCard(SUITS.HEART, 13),   // King of Hearts
      createCard(SUITS.DIAMOND, 13), // King of Diamonds
      createCard(SUITS.CLUB, 13),    // King of Clubs
      createCard(SUITS.SPADE, 13),   // King of Spades
      createCard(SUITS.HEART, 13),   // King of Hearts (duplicate)
      createCard(SUITS.DIAMOND, 13), // King of Diamonds (duplicate)
      createCard(JOKER, 1),          // Joker (wild card)
    ];

    // Opponent Meld Slot 2 with 5-card set/run (Clubs)
    const opponentMeldSlot2Cards = [
      createCard(SUITS.CLUB, 5),
      createCard(SUITS.CLUB, 6),
      createCard(SUITS.CLUB, 7),
      createCard(SUITS.CLUB, 8),
      createCard(SUITS.CLUB, 9)
    ];


    // Get meld slot containers
    const meldSlot1Container = document.getElementById('meld-slot-1').querySelector('.meld-cards');
    const meldSlot2Container = document.getElementById('meld-slot-2').querySelector('.meld-cards');
    const opponentMeldSlot2Container = document.getElementById('opp-meld-slot-2').querySelector('.meld-cards');

    const RANK_NAMES = {
      1: 'ace',
      2: 'two',
      3: 'three',
      4: 'four',
      5: 'five',
      6: 'six',
      7: 'seven',
      8: 'eight',
      9: 'nine',
      10: 'ten',
      11: 'jack',
      12: 'queen',
      13: 'king'
    };

    const RANK_PLURALS = {
      ace: 'aces',
      two: 'twos',
      three: 'threes',
      four: 'fours',
      five: 'fives',
      six: 'sixes',
      seven: 'sevens',
      eight: 'eights',
      nine: 'nines',
      ten: 'tens',
      jack: 'jacks',
      queen: 'queens',
      king: 'kings'
    };

    const SUIT_NAMES = {
      [SUITS.HEART]: 'hearts',
      [SUITS.DIAMOND]: 'diamonds',
      [SUITS.CLUB]: 'clubs',
      [SUITS.SPADE]: 'spades'
    };

    function isConsecutive(ranks) {
      const sorted = [...new Set(ranks)].sort((a, b) => a - b);
      if (sorted.length < 3) return false;
      for (let i = 1; i < sorted.length; i += 1) {
        if (sorted[i] !== sorted[i - 1] + 1) return false;
      }
      return true;
    }

    function getMeldHoverText(cards) {
      if (!cards || cards.length === 0) return '';
      if (cards.length >= 7) return '';

      const nonJokers = cards.filter(card => !card.isJoker);
      if (nonJokers.length === 0) return '';

      const firstRank = nonJokers[0].rank;
      const allSameRank = nonJokers.every(card => card.rank === firstRank);
      if (allSameRank) {
        const rankName = RANK_NAMES[firstRank];
        const rankPlural = RANK_PLURALS[rankName] || `${rankName}s`;
        return `meld of ${rankPlural}`;
      }

      const firstSuit = nonJokers[0].suit;
      const allSameSuit = nonJokers.every(card => card.suit === firstSuit);
      if (allSameSuit && isConsecutive(nonJokers.map(card => card.rank))) {
        const suitName = SUIT_NAMES[firstSuit] || firstSuit.toLowerCase();
        return `set of ${suitName}`;
      }

      return 'meld';
    }

    /**
     * Calculate exact card size for N cards with 70% overlap to fill slot
     * Formula: totalWidth = cardWidth * (1 + (N-1) * overlapPercentage)
     * @param {number} slotWidth - Width of meld slot in px
     * @param {number} slotHeight - Height of meld slot in px
     * @param {number} totalCards - Total number of cards
     * @returns {object} - { cardWidth, cardHeight }
     */
    function calculateCardSize(slotWidth, slotHeight, totalCards) {
      const OVERLAP_PERCENTAGE = 0.3; // 70% overlap means 30% visible
      const CARD_ASPECT_RATIO = 0.75; // width/height ratio of standard playing cards
      const PADDING = 4; // Padding to keep slot frame visible
      
      // Calculate width needed to fit N cards with 70% overlap
      // totalWidth = cardWidth * (1 + (N-1) * 0.3)
      const widthMultiplier = 1 + (totalCards - 1) * OVERLAP_PERCENTAGE;
      const availableWidth = slotWidth - (2 * PADDING);
      const cardWidth = availableWidth / widthMultiplier;
      
      // Use card's aspect ratio for height
      const cardHeight = cardWidth / CARD_ASPECT_RATIO;
      
      // Verify it fits in slot height with padding
      const availableHeight = slotHeight - (2 * PADDING);
      if (cardHeight > availableHeight) {
        const adjustedCardHeight = availableHeight;
        const adjustedCardWidth = adjustedCardHeight * CARD_ASPECT_RATIO;
        return { cardWidth: adjustedCardWidth, cardHeight: adjustedCardHeight };
      }
      
      return { cardWidth, cardHeight };
    }

    /**
     * Calculate card positioning for overlapping effect (70% overlap)
     * @param {number} cardWidth - Width of a single card in px
     * @returns {number} - Horizontal offset between cards
     */
    function calculateCardOffset(cardWidth) {
      // 70% overlap means 30% of card width is visible
      return cardWidth * 0.3;
    }

    /**
     * Populate a meld slot with cards
     * @param {HTMLElement} container - The meld-cards container
     * @param {array} cards - Array of card objects
     */
    function populateMeldSlot(container, cards) {
      // Get meld slot dimensions
      const meldSlot = container.parentElement;
      const slotWidth = meldSlot.offsetWidth;
      const slotHeight = meldSlot.offsetHeight;

      // Calculate exact card size for this many cards
      const { cardWidth, cardHeight } = calculateCardSize(slotWidth, slotHeight, cards.length);
      const cardOffset = calculateCardOffset(cardWidth);
      // Clear container
      container.innerHTML = '';

      // Calculate starting position - first card starts at left with padding
      const PADDING = 4;
      const startX = PADDING;

      // Add cards with positioning
      cards.forEach((card, index) => {
        const img = document.createElement('img');
        img.src = card.svgPath;
        img.alt = `${card.suit} ${card.rank}`;
        img.style.width = `${cardWidth}px`;
        img.style.height = `${cardHeight}px`;
        img.style.left = `${startX + index * cardOffset}px`;
        img.style.zIndex = index;
        
        container.appendChild(img);
      });

      const hoverText = getMeldHoverText(cards);
      if (hoverText) {
        meldSlot.dataset.tooltip = hoverText;
        meldSlot.classList.add('has-tooltip');
      } else {
        delete meldSlot.dataset.tooltip;
        meldSlot.classList.remove('has-tooltip');
      }
    }

    // Wait for meld slots to be measured before populating
    requestAnimationFrame(() => {
      populateMeldSlot(meldSlot1Container, meldSlot1Cards);
      populateMeldSlot(meldSlot2Container, meldSlot2Cards);
      populateMeldSlot(opponentMeldSlot2Container, opponentMeldSlot2Cards);
    });

    // Create ResizeObserver to handle responsive resizing (zoom, window resize, etc.)
    const resizeObserver = new ResizeObserver(() => {
      populateMeldSlot(meldSlot1Container, meldSlot1Cards);
      populateMeldSlot(meldSlot2Container, meldSlot2Cards);
    });

    // Observe both meld slots for size changes
    resizeObserver.observe(meldSlot1Container.parentElement);
    resizeObserver.observe(meldSlot2Container.parentElement);
    resizeObserver.observe(opponentMeldSlot2Container.parentElement);

    // Create a test hand with 4 red threes + 70 regular cards (35 per row)
    const handCards = [];
    
    // Add 4 red threes first (these will be positioned on the left)
    handCards.push(createCard(SUITS.HEART, 3));     // Red Three 1
    handCards.push(createCard(SUITS.DIAMOND, 3));   // Red Three 2
    handCards.push(createCard(SUITS.HEART, 3));     // Red Three 3
    handCards.push(createCard(SUITS.DIAMOND, 3));   // Red Three 4
    
    // Add 70 regular cards (mixed ranks and suits)
    for (let i = 0; i < 40; i++) {
      const suits = [SUITS.HEART, SUITS.DIAMOND, SUITS.CLUB, SUITS.SPADE];
      const rank = (i % 13) + 1;  // Cycle through ranks 1-13
      const suit = suits[i % 4];   // Cycle through suits
      
      // Skip rank 3 for non-red suits to avoid confusion
      if (rank === 3 && suit !== SUITS.HEART && suit !== SUITS.DIAMOND) {
        handCards.push(createCard(suit, 2)); // Use rank 2 instead
      } else if (rank === 3) {
        handCards.push(createCard(suit, 4)); // Use rank 4 instead
      } else {
        handCards.push(createCard(suit, rank));
      }
    }

    // Use all 74 cards (4 red threes + 70 regular)
    const testHand = handCards.slice(0, 74);

    // Calculate hand statistics
    const redThreesCount = testHand.filter(card => 
      card.rank === 3 && (card.suit === SUITS.HEART || card.suit === SUITS.DIAMOND)
    ).length;
    const totalCards = testHand.length - redThreesCount; // Exclude red threes from card count

    // Update counter displays
    document.getElementById('hand-card-count').textContent = totalCards;
    document.getElementById('hand-red3-count').textContent = redThreesCount;

    // Create hand display with click handlers
    const handDisplay = createHandDisplay(testHand, {
      width: '94.5px',
      height: '135px',
      onCardClick: (card, index, event) => {
        console.log(`Played card: ${card.suit} ${card.rank}`);
      }
    });

    document.getElementById('player-hand').appendChild(handDisplay);
    console.log('Player hand loaded with cards:', testHand);
    console.log(`Hand stats: ${totalCards} cards, ${redThreesCount} red threes`);
  </script>
  <script type="module" src="./game.js"></script>
</body>
</html>
